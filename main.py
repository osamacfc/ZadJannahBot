import telebot
import json
import random
import os
from datetime import datetime
from telebot import types
from config import BOT_TOKEN, ADMIN_ID, USERS_DB_PATH, ALL_USERS_CHAT_IDS
from scheduler import schedule_tasks

bot = telebot.TeleBot(BOT_TOKEN)

# ุชุณุฌูู ุงููุณุชุฎุฏู ุชููุงุฆููุง
def register_user(user_id):
    try:
        with open(USERS_DB_PATH, "r") as f:
            users = json.load(f)
    except:
        users = []

    existing_ids = [u["id"] if isinstance(u, dict) else u for u in users]

    if user_id not in existing_ids:
        new_user = {
            "id": user_id,
            "city": "ุบูุฑ ูุญุฏุฏุฉ",
            "dhikr_count": 0,
            "witr": 0,
            "duha_days": 0,
            "last_dua": "",
            "last_seen": str(datetime.now())
        }
        users.append(new_user)
        with open(USERS_DB_PATH, "w") as f:
            json.dump(users, f, ensure_ascii=False, indent=2)

    global ALL_USERS_CHAT_IDS
    ALL_USERS_CHAT_IDS = [u["id"] if isinstance(u, dict) else u for u in users]

# ุฃูุฑ /start โ ุฑุณุงูุฉ ุชุฑุญูุจูุฉ
@bot.message_handler(commands=["start"])
def send_welcome(message):
    register_user(message.chat.id)
    bot.send_message(
        message.chat.id,
        f"ูุฑุญุจูุง {message.from_user.first_name}!\n"
        "ุฃูุง *ZadJannahBot* โ ุฒุงุฏู ุฅูู ุงูุฌูุฉ ุจุฅุฐู ุงููู.\n\n"
        "ุงุจุฏุฃ ุฑุญูุชู ุงูููููุฉ ูุน ุงูุฃุฐูุงุฑ ูุงูุตูุงุฉ ูุงูุฏุนุงุก.\n"
        "ุณูุฐูุฑู ุฏุงุฆููุง ุจูู ุฎูุฑ!",
        parse_mode="Markdown"
    )

# ุฅุนุฏุงุฏ ูุงุฆูุฉ ุงูุฃูุงูุฑ
bot.set_my_commands([
    types.BotCommand("start", "ุจุฏุก ุงูุจูุช"),
    types.BotCommand("azkar", "ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุณุงุก"),
    types.BotCommand("sleep", "ุฃุฐูุงุฑ ุงูููู"),
    types.BotCommand("salat_azkar", "ุฃุฐูุงุฑ ุจุนุฏ ุงูุตูุงุฉ"),
    types.BotCommand("deed", "ุฃูุนุงู ุจุฃุฌูุฑ ุนุธููุฉ"),
    types.BotCommand("witr", "ุชุฐููุฑ ุจุงููุชุฑ + ุฏุนุงุกู"),
    types.BotCommand("name", "ุงุณู ูู ุฃุณูุงุก ุงููู ุงูุญุณูู"),
    types.BotCommand("dua", "ุฏุนุงุก ุนุดูุงุฆู"),
    types.BotCommand("quote", "ูุงู ุฃุญุฏ ุงูุตุงูุญูู"),
    types.BotCommand("khatmah", "ุฌุฒุก ุงูููู ูู ุงููุฑุขู"),
    types.BotCommand("next_salah", "ุงูุตูุงุฉ ุงููุงุฏูุฉ"),
    types.BotCommand("myinfo", "ูููู ุงูุดุฎุตู"),
    types.BotCommand("support", "ุงูุฏุนู ูุงูุฅุนุฏุงุฏุงุช")
])
# ุฏุงูุฉ ุนุฑุถ ุฃุฐูุงุฑ ุงูุตุจุงุญ ุงููุฎุชุตุฑุฉ
def send_short_morning_azkar(user_id):
    short_morning_azkar = """
โ๏ธ *ุฃุฐูุงุฑ ุงูุตุจุงุญ โ ูุฎุชุตุฑุฉ:*

1. *ุขูุฉ ุงููุฑุณู:*  
ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงููููููููููุ ููุง ุชูุฃูุฎูุฐููู ุณูููุฉู ููููุง ููููููุ ูููู ููุง ููู ุงูุณููููุงููุงุชู ููููุง ููู ุงููุฃูุฑูุถู... [ุงูุจูุฑุฉ: 255]

2. *ุณูุฑุฉ ุงูุฅุฎูุงุต:*  
ูููู ูููู ุงูููููู ุฃูุญูุฏูุ ุงูููููู ุงูุตููููุฏูุ ูููู ููููุฏู ูููููู ูููููุฏูุ ูููููู ููููู ููููู ููููููุง ุฃูุญูุฏู.

3. *ุณูุฑุฉ ุงูููู:*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููููููุ ููู ุดูุฑูู ููุง ุฎูููููุ ููููู ุดูุฑูู ุบูุงุณููู ุฅูุฐูุง ููููุจูุ ููููู ุดูุฑูู ุงูููููููุงุซูุงุชู ููู ุงููุนูููุฏูุ ููููู ุดูุฑูู ุญูุงุณูุฏู ุฅูุฐูุง ุญูุณูุฏู.

4. *ุณูุฑุฉ ุงููุงุณ:*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููุงุณูุ ูููููู ุงููููุงุณูุ ุฅููููฐูู ุงููููุงุณูุ ููู ุดูุฑูู ุงููููุณูููุงุณู ุงููุฎููููุงุณูุ ุงูููุฐูู ููููุณูููุณู ููู ุตูุฏููุฑู ุงููููุงุณูุ ูููู ุงููุฌููููุฉู ููุงููููุงุณู.

5. *ุขุฎุฑ ุขูุชูู ูู ุณูุฑุฉ ุงูุจูุฑุฉ:*  
ุขูููู ุงูุฑููุณูููู ุจูููุง ุฃููุฒููู ุฅููููููู ููู ุฑูุจูููู ููุงููููุคูููููููู...  
ููุง ููููููููู ุงูููููู ููููุณูุง ุฅููููุง ููุณูุนูููุง... [ุงูุจูุฑุฉ: 285-286]

6. *ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ููู...*  
ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑ...

7. *ุฑุถูุช ุจุงููู ุฑุจูุง...*  
ุฑุถูุช ุจุงููู ุฑุจููุงุ ูุจุงูุฅุณูุงู ุฏูููุงุ ูุจูุญูุฏ ๏ทบ ูุจูููุง. (ุซูุงุซ ูุฑุงุช)

๐ *ุงููุตุฏุฑ:* ุญุตู ุงููุณูู โ ุงููุตูุต ุงููุงููุฉ.
    """
    bot.send_message(user_id, short_morning_azkar, parse_mode="Markdown")

# ุฒุฑ ุชูุงุนูู ุนูุฏ ุงูุถุบุท ุนูู "ุฃุฐูุงุฑ ูุฎุชุตุฑุฉ"
@bot.callback_query_handler(func=lambda call: call.data == "azkar_morning_short")
def handle_short_morning_azkar(call):
    send_short_morning_azkar(call.message.chat.id)
  # ุฏุงูุฉ ุนุฑุถ ุฃุฐูุงุฑ ุงูุตุจุงุญ ุงููุงููุฉ
def send_full_morning_azkar(user_id):
    full_morning_azkar = """
โ๏ธ *ุฃุฐูุงุฑ ุงูุตุจุงุญ โ ูุงููุฉ:*

1. *ุขูุฉ ุงููุฑุณู:*  
ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงููููููููููุ ููุง ุชูุฃูุฎูุฐููู ุณูููุฉู ููููุง ููููููุ ูููู ููุง ููู ุงูุณููููุงููุงุชู ููููุง ููู ุงููุฃูุฑูุถู... [ุงูุจูุฑุฉ: 255]

2. *ุณูุฑุฉ ุงูุฅุฎูุงุต โ 3 ูุฑุงุช:*  
ูููู ูููู ุงูููููู ุฃูุญูุฏูุ ุงูููููู ุงูุตููููุฏูุ ูููู ููููุฏู ูููููู ูููููุฏูุ ูููููู ููููู ููููู ููููููุง ุฃูุญูุฏู.

3. *ุณูุฑุฉ ุงูููู โ 3 ูุฑุงุช:*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงูููููููู... (ูุงููุฉ).

4. *ุณูุฑุฉ ุงููุงุณ โ 3 ูุฑุงุช:*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููุงุณู... (ูุงููุฉ).

5. *ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ููู...*

6. *ุงูููู ุจู ุฃุตุจุญูุง ูุจู ุฃูุณููุง...*

7. *ุฑุถูุช ุจุงููู ุฑุจูุง...* (ุซูุงุซ ูุฑุงุช)

8. *ุงูููู ูุง ุฃุตุจุญ ุจู ูู ูุนูุฉ...*

9. *ุงูููู ุนุงููู ูู ุจุฏูู...* (ุซูุงุซ ูุฑุงุช)

10. *ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ...*

11. *ุงูููู ุฅูู ุฃุตุจุญุช ุฃุดูุฏู...* (ุฃุฑุจุน ูุฑุงุช)

12. *ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ูู...* (ุณุจุน ูุฑุงุช)

13. *ุงูููู ุฅูู ุฃุนูุฐ ุจู ูู ุงููู ูุงูุญุฒู...*

14. *ุงูููู ุฅูู ุฃุนูุฐ ุจู ูู ุงูููุฑ ูุงูููุฑ...*

15. *ุงูููู ุฅูู ุฃุนูุฐ ุจู ูู ุงูุฌุจู ูุงูุจุฎู...*

16. *ุงูููู ุฅูู ุฃุณุฃูู ุนููุงู ูุงูุนูุง...*

17. *ุงุณุชุบูุฑ ุงููู ุงูุนุธูู ูุฃุชูุจ ุฅููู.*

18. *ุณุจุญุงู ุงููู ูุจุญูุฏู โ 100 ูุฑุฉ*

19. *ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ูู...* โ 100 ูุฑุฉ

20. *ุขุฎุฑ ุขูุชูู ูู ุณูุฑุฉ ุงูุจูุฑุฉ:*  
ุขูููู ุงูุฑููุณูููู...  
ููุง ููููููููู ุงูููููู ููููุณูุง ุฅููููุง ููุณูุนูููุง... [ุงูุจูุฑุฉ: 285โ286]

๐ *ุงููุตุฏุฑ:* ุญุตู ุงููุณูู โ ุงูุตูุบุฉ ุงููุงููุฉ ุงููุนุชูุฏุฉ.
    """
    bot.send_message(user_id, full_morning_azkar, parse_mode="Markdown")

# ุฒุฑ ุชูุงุนูู ุนูุฏ ุงูุถุบุท ุนูู "ุฃุฐูุงุฑ ูุงููุฉ"
@bot.callback_query_handler(func=lambda call: call.data == "azkar_morning_full")
def handle_full_morning_azkar(call):
    send_full_morning_azkar(call.message.chat.id)
  # ุฏุงูุฉ ุนุฑุถ ุฃุฐูุงุฑ ุงููุณุงุก ุงููุฎุชุตุฑุฉ
def send_short_evening_azkar(user_id):
    short_evening_azkar = """
๐ *ุฃุฐูุงุฑ ุงููุณุงุก โ ูุฎุชุตุฑุฉ:*

1. *ุขูุฉ ุงููุฑุณู:*  
ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู... [ุงูุจูุฑุฉ: 255]

2. *ุณูุฑุฉ ุงูุฅุฎูุงุต*  
ูููู ูููู ุงูููููู ุฃูุญูุฏูุ ุงูููููู ุงูุตููููุฏู... (ูุงููุฉ)

3. *ุณูุฑุฉ ุงูููู*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงูููููููู... (ูุงููุฉ)

4. *ุณูุฑุฉ ุงููุงุณ*  
ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููุงุณู... (ูุงููุฉ)

5. *ุขุฎุฑ ุขูุชูู ูู ุณูุฑุฉ ุงูุจูุฑุฉ:*  
ุขูููู ุงูุฑููุณูููู...  
ููุง ููููููููู ุงูููููู ููููุณูุง ุฅููููุง ููุณูุนูููุง... [ุงูุจูุฑุฉ: 285โ286]

6. *ุฃูุณููุง ูุฃูุณู ุงูููู ููู...*

7. *ุฑุถูุช ุจุงููู ุฑุจูุง...* (ุซูุงุซ ูุฑุงุช)

๐ *ุงููุตุฏุฑ:* ุญุตู ุงููุณูู โ ูุฎุชุงุฑุฉ ุจุตูุบ ูุงููุฉ
    """
    bot.send_message(user_id, short_evening_azkar, parse_mode="Markdown")

# ุฒุฑ ุชูุงุนูู ุนูุฏ ุงูุถุบุท ุนูู "ุฃุฐูุงุฑ ุงููุณุงุก ุงููุฎุชุตุฑุฉ"
@bot.callback_query_handler(func=lambda call: call.data == "azkar_evening_short")
def handle_short_evening_azkar(call):
    send_short_evening_azkar(call.message.chat.id)
  # ุฏุงูุฉ ุนุฑุถ ุฃุฐูุงุฑ ุงููุณุงุก ุงููุงููุฉ
def send_full_evening_azkar(user_id):
    full_evening_azkar = """
๐ *ุฃุฐูุงุฑ ุงููุณุงุก โ ูุงููุฉ:*

1. *ุขูุฉ ุงููุฑุณู* โ [ุงูุจูุฑุฉ: 255]

2. *ุงูุฅุฎูุงุต โ 3 ูุฑุงุช*

3. *ุงูููู โ 3 ูุฑุงุช*

4. *ุงููุงุณ โ 3 ูุฑุงุช*

5. *ุฃูุณููุง ูุฃูุณู ุงูููู ููู...*

6. *ุงูููู ุจู ุฃูุณููุง ูุจู ุฃุตุจุญูุง...*

7. *ุฑุถูุช ุจุงููู ุฑุจูุง...* โ (ุซูุงุซ ูุฑุงุช)

8. *ุงูููู ูุง ุฃูุณู ุจู ูู ูุนูุฉ...*

9. *ุงูููู ุนุงููู ูู ุจุฏูู...* โ (ุซูุงุซ ูุฑุงุช)

10. *ุงูููู ุฅูู ุฃุณุฃูู ุงูุนูู ูุงูุนุงููุฉ...*

11. *ุงูููู ุฅูู ุฃูุณูุช ุฃุดูุฏู...* โ (ุฃุฑุจุน ูุฑุงุช)

12. *ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ูู...* โ (ุณุจุน ูุฑุงุช)

13. *ุงูููู ุฅูู ุฃุนูุฐ ุจู ูู ุงููู ูุงูุญุฒู...*

14. *ุงูููู ุฅูู ุฃุนูุฐ ุจู ูู ุงููุณู ูุงูุนุฌุฒ...*

15. *ุงุณุชุบูุฑ ุงููู ุงูุนุธูู ูุฃุชูุจ ุฅููู.*

16. *ุณุจุญุงู ุงููู ูุจุญูุฏู โ 100 ูุฑุฉ*

17. *ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ูู...* โ 100 ูุฑุฉ

18. *ุขุฎุฑ ุขูุชูู ูู ุณูุฑุฉ ุงูุจูุฑุฉ* โ [ุงูุจูุฑุฉ: 285โ286]

๐ *ุงููุตุฏุฑ:* ุญุตู ุงููุณูู โ ุงูุตูุบุฉ ุงููุงููุฉ
    """
    bot.send_message(user_id, full_evening_azkar, parse_mode="Markdown")

# ุฒุฑ ุชูุงุนูู ุนูุฏ ุงูุถุบุท ุนูู "ุฃุฐูุงุฑ ุงููุณุงุก ุงููุงููุฉ"
@bot.callback_query_handler(func=lambda call: call.data == "azkar_evening_full")
def handle_full_evening_azkar(call):
    send_full_evening_azkar(call.message.chat.id)
  
